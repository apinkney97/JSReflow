# Master makefile for GNU font utilities.
#
# Copyright (C) 1992 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 1, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

# Version number of this release.
version = 0.4

# Installation directories.
prefix = @prefix@
bindir = $(prefix)/bin
datadir = $(prefix)/lib/fontutil
infodir = $(prefix)/info

# Where the default resource files for X programs get installed.  If you
# don't want to or can't write in standard app-defaults directory, you
# can put it anywhere you like, and set the XENVIRONMENT variable to the
# path.  See the tutorial on resources in the X distribution
# (.../mit/doc/tutorial/resources.txt) for more information.
app_defaults_dir = $(prefix)/lib/X11/app-defaults

# Default paths for you to override.  You can either change these and
# run `make', or copy include/paths.h.in to include/paths.h and change
# them manually.  These paths are overridden by various environment
# variables; see the documentation.  The current directory is
# automatically searched first.
default_lib_path = $(shell pwd)/data:$(datadir)
default_tfm_path = /usr/local/lib/tex/fonts//
default_pk_path = $(default_tfm_path)
default_gf_path = $(default_tfm_path)

# Start of system configuration section.
SHELL = /bin/sh
srcdir = @srcdir@
@VPATH@

# Make #include <X11/...> work.
xincludedir = @xincludedir@

# Make -lX... work
xlibdir = @xlibdir@

CC = @CC@
cdebug = -g
# We use .. because we always compile in subdirectories.
CFLAGS = -I../$(srcdir)/include $(cdebug) $(XCFLAGS) $(xincludedir)

LDFLAGS = @LDFLAGS@ $(xlibdir) $(cdebug) $(XLDFLAGS)
LIBS = @LIBS@ -lm
wlibs = @wlibs@

RANLIB = @RANLIB@

INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@


# You shouldn't need to change anything below here.

libraries = bzr gf lib pbm pk tfm widgets
programs = bzrto charspace fontconvert gsrenderfont imagetofont imgrotate \
	   limn xbfe
alldirs = $(libraries) $(programs)

default: all

.PHONY: all install libraries clean realclean distclean depend TAGS dist

# Prevent GNU make from exporting all environment variables, as this
# makes the arg list too long on some systems.
.NOEXPORT:

include/paths.h: include/paths.h.in
	echo "/* Generated by make from paths.h.in (`date`).  */" \
          > include/paths.h
	sed -e "s,replace-with-lib-path,$(default_lib_path)," \
            -e "s,replace-with-tfm-path,$(default_tfm_path)," \
            -e "s,replace-with-pk-path,$(default_pk_path)," \
            -e "s,replace-with-gf-path,$(default_gf_path)," \
          include/paths.h.in >> include/paths.h
            

makeargs = CC="$(CC)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)" \
  RANLIB="$(RANLIB)" wlibs="$(wlibs)" xlibdir="$(xlibdir)"

all:	include/paths.h libraries 
	for dir in $(programs);						\
	do								\
	  (cd $${dir}; make $(makeargs));				\
	done


installargs = bindir=$(bindir) datadir=$(datadir) 			\
  app_defaults_dir=$(app_defaults_dir)					\
  INSTALL="$(INSTALL)" INSTALL_DATA="$(INSTALL_DATA)"			\
  INSTALL_PROGRAM="$(INSTALL_PROGRAM)"

install:
	for dir in $(programs);						\
        do								\
          (cd $${dir}; make $(installargs) install);			\
        done


libraries: 
	for dir in $(libraries);					\
	do								\
	  (cd $${dir}; make $(makeargs));				\
        done


# Source files from all directories to be distributed.
srcfiles = ChangeLog,GNUmakefile,M.depend,README,*.c,*.h

# Extra source files in program directories only.
progfiles = TAGS,.gdbinit,*.ad

# Files in the top level directory to be distributed.
topfiles = AUTHORS COPYING COPYING.LIB ChangeLog INSTALL Makefile.in  \
           README configure configure.in

# Directories whose complete contents are to be distributed.
completedirs = bin data doc include

# Other stuff that doesn't fall into the neat categories above.
bzrtospecial = KKBuildChar.PS,bzrsetup.mf
gsrenderspecial = gsrenderfont,fixifibb.awk,writefont.PS

# Files which have version numbers in them.
versionfiles = gsrenderfont/gsrenderfont */version.c

distdir = fontutils-$(version)

dist: configure #depend TAGS
	rm -rf $(distdir)
	-mkdir $(distdir)
	cp -p $(app_defaults_dir)/Limn limn/Limn.ad
	cp -p $(app_defaults_dir)/XBfe xbfe/XBfe.ad
	ln $(topfiles) $(distdir)
	(cd $(distdir);							\
          for dir in $(completedirs);					\
          do								\
            (mkdir $${dir}; cd $${dir}; ln ../../$${dir}/* .);		\
          done;								\
          for dir in $(alldirs);					\
          do								\
            mkdir $${dir};						\
            bash -c "(cd $${dir}; ln ../../$${dir}/{$(srcfiles)} .)";	\
          done;								\
          for dir in $(programs);					\
          do								\
            bash -c "(cd $${dir}; ln ../../$${dir}/{$(progfiles)} .)";	\
          done;								\
          bash -c "ln ../bzrto/{$(bzrtospecial)} bzrto";		\
          bash -c "ln ../gsrenderfont/{$(gsrenderspecial)} gsrenderfont";\
          rm -f include/c-auto.h include/paths.h;			\
          add-version $(version) $(versionfiles)			\
        )
	tar czf fontutils-$(version).tar.Z fontutils-$(version)
	rm -f */*.ad
	rm -rf fontutils-$(version)

configure: configure.in
	autoconf

TAGS:
	for dir in $(programs);						\
	do								\
	  (cd $${dir}; make $@);					\
	done

depend: include/paths.h
	for dir in $(alldirs);						\
	do								\
	  (cd $${dir}; make $@);					\
	done

mostlyclean clean realclean::
	for dir in $(alldirs);						\
	do								\
	  (cd $${dir}; make $@);					\
	done

clean::
	rm -f include/c-auto.h include/paths.h config.status Makefile
